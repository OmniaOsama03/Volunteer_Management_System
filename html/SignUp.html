<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - EventLink</title>
    <link rel="stylesheet" href="../css/SignUp.css">
</head>
<body>
    <div class="content">
        <p class="small-text">Start today!</p>
        <h1>Create an account</h1>
        <p class="small-text">Already have an account? <a href="SignIn.html">Sign in!</a></p>

        <form id="signup-form">
            <div class="name-fields">
                <input type="text" name="firstName" placeholder="First Name" required>
                <input type="text" name="lastName" placeholder="Last Name" required>
            </div>

            <input type="email" name="email" placeholder="Email" required>
            <div>
                <input type="password" name="password" placeholder="Password" required id="password">
                <span id="strengthFeedback" class="feedback"></span>
            </div>
            <div>
                <input type="password" name="confirmPassword" placeholder="Confirm Password" required id="confirmPassword">
                <span id="passwordFeedback" class="feedback"></span>
            </div>
            <button type="submit">Create Account</button>
        </form>
    </div>

    <script>
        // A function to check if a the passwords match
        function checkPasswordMatch() {
            const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirmPassword").value;
            const feedback = document.getElementById('passwordFeedback');

            const xhttp = new XMLHttpRequest();
            xhttp.open("POST", "http://35.224.154.82/users/checkPassword", true);
            xhttp.setRequestHeader("Content-Type", "application/json");
    
            xhttp.onload = function () {
                if (xhttp.status >= 200 && xhttp.status < 300) {
                    const response = JSON.parse(xhttp.responseText);
                    feedback.textContent = response.match ? 'Match' : 'No Match';
                } else {
                    feedback.textContent = 'Error checking password';
                }
            };
    
            xhttp.send(JSON.stringify({ password, confirmPassword }));
        }


        // A function to check the passwords Strength
        function checkPasswordStrength() {
            const password = document.getElementById('password').value;

            const feedback = document.getElementById('strengthFeedback');
            const xhttp = new XMLHttpRequest();
    
            xhttp.open("POST", "http://35.224.154.82/users/checkPasswordStrength", true);
            xhttp.setRequestHeader("Content-Type", "application/json");
    
            xhttp.onload = function () {
                if (xhttp.status >= 200 && xhttp.status < 300) {
                    const response = JSON.parse(xhttp.responseText);
                    if (response.isStrong) {
                        feedback.textContent = 'Strong Password';
                    } else {
                        let errorMessage = 'Weak Password: ';
                        if (!response.hasCapital) errorMessage += 'Needs a capital letter. ';
                        if (!response.hasNum) errorMessage += 'Needs a number. ';
                        if (!response.isLongEnough) errorMessage += 'Needs to be at least 8 characters long.';
                        feedback.textContent = errorMessage;
                    }
                } else {
                    feedback.textContent = 'Error checking password strength';
                }
            };
    
            xhttp.send(JSON.stringify({ password }));
        }
    

        // Handles form submission asynchronously
        async function handleFormSubmit(event) {
            event.preventDefault();
    
            const passwordFeedback = document.getElementById('passwordFeedback').textContent;
            const strengthFeedback = document.getElementById('strengthFeedback').textContent;
    
            if (passwordFeedback !== 'Match' || !strengthFeedback.includes('Strong Password')) {
                alert('Password must be strong and match the confirmation password.');
                return;
            }

            const form = event.target;
            const data = { // Collects form data into an object
                firstName: form.elements['firstName'].value,
                lastName: form.elements['lastName'].value,
                email: form.elements['email'].value,
                password: form.elements['password'].value
            };
    
            try {  // Sends a POST request to the server to create a new user
                const response = await fetch('http://35.224.154.82/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
    
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
    
                alert('Account created successfully!');
                window.location.href = 'HomePage.html';
                form.reset();
            } catch (error) {
                alert('An Account with this Email Already Exists!');
            }
        }
    
    // Adds event listeners once the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('signup-form'); // Gets the signup form element
        form.addEventListener('submit', handleFormSubmit); // Adds a submit event listener to the form

        const passwordInput = document.getElementById('password'); // Gets the password input element
        passwordInput.addEventListener('input', checkPasswordStrength); // Adds an input event listener to check password strength

        const confirmPasswordInput = document.getElementById('confirmPassword'); // Gets the confirm password input element
        confirmPasswordInput.addEventListener('input', checkPasswordMatch); // Adds an input event listener to check password match
    });

    </script>
</body>
</html>
